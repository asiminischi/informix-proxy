#!/bin/bash

#############################################################################
# Informix gRPC Proxy - Directory Setup Script
#############################################################################

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘        Informix gRPC Proxy - Directory Setup              â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check if we're in the right place
if [ ! -f "pom.xml" ]; then
    echo "âŒ Error: pom.xml not found."
    echo "   Please run this script from the informix-proxy root directory."
    exit 1
fi

echo "ğŸ“ Creating directory structure..."
echo ""

# Create all necessary directories
mkdir -p proto
mkdir -p src/main/java/com/informix/grpc
mkdir -p scripts
mkdir -p lib
mkdir -p clients/nodejs
mkdir -p clients/python
mkdir -p monitoring/grafana/provisioning/datasources
mkdir -p monitoring/grafana/provisioning/dashboards
mkdir -p monitoring/grafana/dashboards
mkdir -p target

echo "âœ… Directories created successfully!"
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    DIRECTORY TREE                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

tree -L 3 -d --charset ascii || ls -R

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                  NEXT STEPS                                â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1ï¸âƒ£  Copy files to their locations:"
echo ""
echo "   proto/"
echo "   â””â”€â”€ informix.proto                          â† API definition"
echo ""
echo "   src/main/java/com/informix/grpc/"
echo "   â””â”€â”€ InformixProxyServer.java                â† Main service"
echo ""
echo "   monitoring/"
echo "   â”œâ”€â”€ prometheus.yml                          â† Metrics config"
echo "   â”œâ”€â”€ alerts.yml                              â† Alert rules"
echo "   â”œâ”€â”€ alertmanager-no-slack.yml               â† Notifications (EDIT THIS!)"
echo "   â””â”€â”€ grafana/"
echo "       â”œâ”€â”€ provisioning/"
echo "       â”‚   â”œâ”€â”€ datasources/datasources.yml"
echo "       â”‚   â””â”€â”€ dashboards/dashboards.yml"
echo "       â””â”€â”€ dashboards/"
echo "           â””â”€â”€ informix-proxy-dashboard.json"
echo ""
echo "   clients/nodejs/"
echo "   â”œâ”€â”€ package.json"
echo "   â””â”€â”€ informix-client.js                      â† Node.js client"
echo ""
echo "   clients/python/"
echo "   â”œâ”€â”€ requirements.txt"
echo "   â””â”€â”€ informix_client.py                      â† Python client"
echo ""
echo "   scripts/"
echo "   â””â”€â”€ init-db.sh                              â† Database init"
echo ""
echo "   Root files:"
echo "   â”œâ”€â”€ pom.xml                                 â† Already exists"
echo "   â”œâ”€â”€ Dockerfile"
echo "   â”œâ”€â”€ docker-compose.prod.yml                 â† Full stack config"
echo "   â”œâ”€â”€ README.md"
echo "   â”œâ”€â”€ MONITORING.md"
echo "   â””â”€â”€ FILE_STRUCTURE.md"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "2ï¸âƒ£  Configure email alerts:"
echo ""
echo "   Edit: monitoring/alertmanager-no-slack.yml"
echo "   Lines 11-15:"
echo ""
echo "   smtp_smarthost: 'smtp.gmail.com:587'"
echo "   smtp_from: 'your-email@gmail.com'"
echo "   smtp_auth_username: 'your-email@gmail.com'"
echo "   smtp_auth_password: 'your-app-password'"
echo ""
echo "   Gmail users: Get app password at:"
echo "   https://myaccount.google.com/apppasswords"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "3ï¸âƒ£  Build the project:"
echo ""
echo "   $ mvn clean package"
echo ""
echo "   This will:"
echo "   â€¢ Download Informix JDBC driver from Maven Central"
echo "   â€¢ Generate gRPC code from proto file"
echo "   â€¢ Compile Java sources"
echo "   â€¢ Create fat JAR: target/informix-grpc-proxy-1.0.0.jar"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "4ï¸âƒ£  Start everything:"
echo ""
echo "   $ docker-compose -f docker-compose.prod.yml up -d"
echo ""
echo "   This starts:"
echo "   â€¢ Informix test database (port 9088)"
echo "   â€¢ gRPC Proxy (port 50051)"
echo "   â€¢ Prometheus (port 9091)"
echo "   â€¢ Grafana (port 3000)"
echo "   â€¢ Alertmanager (port 9093)"
echo "   â€¢ Node Exporter (port 9100)"
echo "   â€¢ cAdvisor (port 8080)"
echo "   â€¢ Loki (port 3100)"
echo "   â€¢ Promtail"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "5ï¸âƒ£  Access services:"
echo ""
echo "   Grafana:       http://localhost:3000   (admin/admin)"
echo "   Prometheus:    http://localhost:9091"
echo "   Alertmanager:  http://localhost:9093"
echo "   Proxy gRPC:    localhost:50051"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "6ï¸âƒ£  Test with Node.js:"
echo ""
echo "   $ cd clients/nodejs"
echo "   $ npm install"
echo "   $ node test.js"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "7ï¸âƒ£  Test with Python:"
echo ""
echo "   $ cd clients/python"
echo "   $ pip install -r requirements.txt"
echo "   $ python -m grpc_tools.protoc -I../../proto --python_out=. --grpc_python_out=. ../../proto/informix.proto"
echo "   $ python example.py"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… Setup complete! Follow the steps above to get started."
echo ""
echo "ğŸ“– For detailed documentation, see:"
echo "   â€¢ FILE_STRUCTURE.md  (file organization)"
echo "   â€¢ README.md          (full documentation)"
echo "   â€¢ MONITORING.md      (observability guide)"
echo ""